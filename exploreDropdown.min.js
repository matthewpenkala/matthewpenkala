$(document).ready(function() {
    let rotating = true;
    let isOpen = false; // Track whether the arrow is currently "open" (rotated 180°) or not.

    function rotateArrow(element, duration, open) {
        // open == true means rotate from 0° to 180°
        // open == false means rotate from 180° to 0°
        const easingFunction = t => t < 0.5 
            ? 4 * t * t * t 
            : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;

        const startAngle = open ? 0 : 180;
        const endAngle = open ? 180 : 0;

        return new Promise(resolve => {
            let start = performance.now();

            function animate(timestamp) {
                let elapsed = timestamp - start;
                let progress = Math.min(elapsed / duration, 1);
                let easedProgress = easingFunction(progress);
                let currentAngle = startAngle + (endAngle - startAngle) * easedProgress;
                element.style.transform = `rotate(${currentAngle}deg)`;

                if (elapsed < duration && rotating) {
                    requestAnimationFrame(animate);
                } else {
                    resolve();
                }
            }

            requestAnimationFrame(animate);
        });
    }

    const hoverableElements = $("[class*='navbar-menu-item']")
        .filter(":contains('Explore')")
        .closest("[data-hover]")
        .find("*:not(path)");
    const toggleElement = hoverableElements.filter(".w-dropdown-toggle").first();
    const arrowElement = hoverableElements.find("svg").parent().first();

    // Start at 0° (closed)
    arrowElement.css("transform", "rotate(0deg)");

    toggleElement.hover(
        function() {
            // On hover in, if not open, rotate to 180°
            if (!isOpen && arrowElement.length) {
                $(this).addClass("w-hover");
                rotateArrow(arrowElement[0], 250, true).then(() => {
                    isOpen = true;
                });
            }
        },
        function() {
            // On hover out, if open, rotate back to 0°
            if (isOpen) {
                $(this).removeClass("w-hover");
                rotateArrow(arrowElement[0], 250, false).then(() => {
                    isOpen = false;
                });
            }
        }
    ).click(function() {
        // On click, toggle the state
        if (isOpen) {
            $(this).removeClass("w-hover");
            rotateArrow(arrowElement[0], 250, false).then(() => {
                isOpen = false;
            });
        } else {
            $(this).addClass("w-hover");
            rotateArrow(arrowElement[0], 250, true).then(() => {
                isOpen = true;
            });
        }
    });
});
