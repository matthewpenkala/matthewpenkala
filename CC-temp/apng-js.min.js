!function(a,b){"object"==typeof exports&&"object"==typeof module?module.exports=b():"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?exports["apng-js"]=b():a["apng-js"]=b()}(this,function(){function a(d){if(c[d])return c[d].exports;var e=c[d]={exports:{},id:d,loaded:!1};return b[d].call(e.exports,e,e.exports,a),e.loaded=!0,e.exports}return c={},a.m=b=[function(b,c,e){"use strict";function j(b,c){for(var d,e,f,g=new DataView(b.buffer),h=8;d=g.getUint32(h),f=c((e=h+4,f=Array.prototype.slice.call(b.subarray(e,e+4)),e=String.fromCharCode.apply(String,f)),b,h,d),h+=12+d,!1!==f&&"IEND"!=e&&h<b.length;);}function d(a,b,c){var d=new Uint8Array(c);return d.set(a.subarray(b,b+c)),d}Object.defineProperty(c,"__esModule",{value:!0}),c.isNotPNG=function(a){return a===p},c.isNotAPNG=function(b){return b===a},c.default=function(b){var g=new Uint8Array(b);if(Array.prototype.some.call(m,function(a,b){return a!==g[b]}))return p;var q=!1;if(j(g,function(a){return!(q="acTL"===a)}),!q)return a;var v=[],w=[],u=null,x=null,y=0,z=new k.APNG;if(j(g,function(b,c,e,f){var g=new DataView(c.buffer);switch(b){case"IHDR":u=c.subarray(e+8,e+8+f),z.width=g.getUint32(e+8),z.height=g.getUint32(e+12);break;case"acTL":z.numPlays=g.getUint32(e+8+4);break;case"fcTL":x&&(z.frames.push(x),y++),(x=new k.Frame).width=g.getUint32(e+8+4),x.height=g.getUint32(e+8+8),x.left=g.getUint32(e+8+12),x.top=g.getUint32(e+8+16);var h=g.getUint16(e+8+20),i=g.getUint16(e+8+22);0===i&&(i=100),x.delay=1e3*h/i,10>=x.delay&&(x.delay=100),z.playTime+=x.delay,x.disposeOp=g.getUint8(e+8+24),x.blendOp=g.getUint8(e+8+25),x.dataParts=[],0===y&&2===x.disposeOp&&(x.disposeOp=1);break;case"fdAT":x&&x.dataParts.push(c.subarray(e+8+4,e+8+f));break;case"IDAT":x&&x.dataParts.push(c.subarray(e+8,e+8+f));break;case"IEND":w.push(d(c,e,12+f));break;default:v.push(d(c,e,12+f));}}),x&&z.frames.push(x),0==z.frames.length)return a;var f=new Blob(v),n=new Blob(w);return z.frames.forEach(function(a){var b=[];b.push(m),u.set(o(a.width),0),u.set(o(a.height),4),b.push(l("IHDR",u)),b.push(f),a.dataParts.forEach(function(a){return b.push(l("IDAT",a))}),b.push(n),a.imageData=new Blob(b,{type:"image/png"}),delete a.dataParts,b=null}),z};var f=(c=e(1))&&c.__esModule?c:{default:c},k=e(2),p=new Error("Not a PNG"),a=new Error("Not an animated PNG"),m=new Uint8Array([137,80,78,71,13,10,26,10]),l=function(a,b){var c=a.length+b.length,d=new Uint8Array(c+8),e=new DataView(d.buffer);return e.setUint32(0,b.length),d.set(function(a){for(var b=new Uint8Array(a.length),c=0;c<a.length;c++)b[c]=a.charCodeAt(c);return b}(a),4),d.set(b,8),b=(0,f.default)(d,4,c),e.setUint32(c+4,b),d},o=function(a){return new Uint8Array([255&a>>>24,255&a>>>16,255&a>>>8,255&a])}},function(a,b){"use strict";Object.defineProperty(b,"__esModule",{value:!0}),b.default=function(a){for(var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,d=-1,e=b,f=b+(2<arguments.length&&void 0!==arguments[2]?arguments[2]:a.length-b);e<f;e++)d=d>>>8^c[255&(d^a[e])];return-1^d};for(var c=new Uint32Array(256),d=0;256>d;d++){for(var e=d,f=0;8>f;f++)e=0==(1&e)?e>>>1:3988292384^e>>>1;c[d]=e}},function(b,c,d){"use strict";function e(a,b,c){return b&&f(a.prototype,b),c&&f(a,c),a}function f(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function g(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function a(){g(this,a),this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.imageData=null,this.imageElement=null}function h(){g(this,h),this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[]}Object.defineProperty(c,"__esModule",{value:!0}),c.Frame=c.APNG=void 0;var j=(d=d(3))&&d.__esModule?d:{default:d};c.APNG=(e(h,[{key:"createImages",value:function(){return Promise.all(this.frames.map(function(a){return a.createImage()}))}},{key:"getPlayer",value:function(a){var b=this,c=1<arguments.length&&void 0!==arguments[1]&&arguments[1];return this.createImages().then(function(){return new j.default(b,a,c)})}}]),h),c.Frame=(e(a,[{key:"createImage",value:function(){var a=this;return this.imageElement?Promise.resolve():new Promise(function(b,c){var d=URL.createObjectURL(a.imageData);a.imageElement=document.createElement("img"),a.imageElement.onload=function(){URL.revokeObjectURL(d),b()},a.imageElement.onerror=function(){URL.revokeObjectURL(d),a.imageElement=null,c(new Error("Image creation error"))},a.imageElement.src=d})}}]),a)},function(a,b,c){"use strict";function d(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function f(a,b,c){!function(a){if(!(a instanceof f))throw new TypeError("Cannot call a class as a function")}(this);var d=function(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"==typeof b||"function"==typeof b)?b:a}(this,(f.__proto__||Object.getPrototypeOf(f)).call(this));return d.playbackRate=1,d._currentFrameNumber=0,d._ended=!1,d._paused=!0,d._numPlays=0,d._apng=a,d.context=b,d.stop(),c&&d.play(),d}Object.defineProperty(b,"__esModule",{value:!0});var e=function(a,b,c){return b&&d(a.prototype,b),c&&d(a,c),a};(function(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)})(f,((c=c(4))&&c.__esModule?c:{default:c}).default),e(f,[{key:"renderNextFrame",value:function(){this._currentFrameNumber=(this._currentFrameNumber+1)%this._apng.frames.length,this._currentFrameNumber===this._apng.frames.length-1&&(this._numPlays++,0!==this._apng.numPlays&&this._numPlays>=this._apng.numPlays&&(this._ended=!0,this._paused=!0)),this._prevFrame&&1==this._prevFrame.disposeOp?this.context.clearRect(this._prevFrame.left,this._prevFrame.top,this._prevFrame.width,this._prevFrame.height):this._prevFrame&&2==this._prevFrame.disposeOp&&this.context.putImageData(this._prevFrameData,this._prevFrame.left,this._prevFrame.top);var a=this.currentFrame;this._prevFrame=a,this._prevFrameData=null,2==a.disposeOp&&(this._prevFrameData=this.context.getImageData(a.left,a.top,a.width,a.height)),0==a.blendOp&&this.context.clearRect(a.left,a.top,a.width,a.height),this.context.drawImage(a.imageElement,a.left,a.top),this.emit("frame",this._currentFrameNumber),this._ended&&this.emit("end")}},{key:"play",value:function(){var a=this;this.emit("play"),this._ended&&this.stop(),this._paused=!1;var b=performance.now()+this.currentFrame.delay/this.playbackRate;requestAnimationFrame(function c(d){if(!a._ended&&!a._paused){if(b<=d){for(;d-b>=a._apng.playTime/a.playbackRate;)b+=a._apng.playTime/a.playbackRate,a._numPlays++;for(;a.renderNextFrame(),b+=a.currentFrame.delay/a.playbackRate,!a._ended&&b<d;);}requestAnimationFrame(c)}})}},{key:"pause",value:function(){this._paused||(this.emit("pause"),this._paused=!0)}},{key:"stop",value:function(){this.emit("stop"),this._numPlays=0,this._ended=!1,this._paused=!0,this._currentFrameNumber=-1,this.context.clearRect(0,0,this._apng.width,this._apng.height),this.renderNextFrame()}},{key:"currentFrameNumber",get:function(){return this._currentFrameNumber}},{key:"currentFrame",get:function(){return this._apng.frames[this._currentFrameNumber]}},{key:"paused",get:function(){return this._paused}},{key:"ended",get:function(){return this._ended}}]),e=f,b.default=e},function(a){function b(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function c(a){return"function"==typeof a}function d(a){return"object"==typeof a&&null!==a}function f(a){return void 0===a}((a.exports=b).EventEmitter=b).prototype._events=void 0,b.prototype._maxListeners=void 0,b.defaultMaxListeners=10,b.prototype.setMaxListeners=function(a){if("number"!=typeof a||0>a||isNaN(a))throw TypeError("n must be a positive number");return this._maxListeners=a,this},b.prototype.emit=function(b){var e,g,h,j,k,l;if(this._events||(this._events={}),"error"===b&&(!this._events.error||d(this._events.error)&&!this._events.error.length)){if((e=arguments[1])instanceof Error)throw e;var m=new Error("Uncaught, unspecified \"error\" event. ("+e+")");throw m.context=e,m}if(f(g=this._events[b]))return!1;if(c(g))switch(arguments.length){case 1:g.call(this);break;case 2:g.call(this,arguments[1]);break;case 3:g.call(this,arguments[1],arguments[2]);break;default:j=Array.prototype.slice.call(arguments,1),g.apply(this,j);}else if(d(g))for(j=Array.prototype.slice.call(arguments,1),h=(l=g.slice()).length,k=0;k<h;k++)l[k].apply(this,j);return!0},b.prototype.on=b.prototype.addListener=function(a,e){var g;if(!c(e))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",a,c(e.listener)?e.listener:e),this._events[a]?d(this._events[a])?this._events[a].push(e):this._events[a]=[this._events[a],e]:this._events[a]=e,d(this._events[a])&&!this._events[a].warned&&(g=f(this._maxListeners)?b.defaultMaxListeners:this._maxListeners)&&0<g&&this._events[a].length>g&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),"function"==typeof console.trace&&console.trace()),this},b.prototype.once=function(a,b){function d(){this.removeListener(a,d),e||(e=!0,b.apply(this,arguments))}if(!c(b))throw TypeError("listener must be a function");var e=!1;return d.listener=b,this.on(a,d),this},b.prototype.removeListener=function(a,b){var e,f,g,h;if(!c(b))throw TypeError("listener must be a function");if(!this._events||!this._events[a])return this;if(g=(e=this._events[a]).length,f=-1,e===b||c(e.listener)&&e.listener===b)delete this._events[a],this._events.removeListener&&this.emit("removeListener",a,b);else if(d(e)){for(h=g;0<h--;)if(e[h]===b||e[h].listener&&e[h].listener===b){f=h;break}if(0>f)return this;1===e.length?(e.length=0,delete this._events[a]):e.splice(f,1),this._events.removeListener&&this.emit("removeListener",a,b)}return this},b.prototype.removeAllListeners=function(a){var b,d;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[a]&&delete this._events[a],this;if(0===arguments.length){for(b in this._events)"removeListener"!==b&&this.removeAllListeners(b);return this.removeAllListeners("removeListener"),this._events={},this}if(c(d=this._events[a]))this.removeListener(a,d);else if(d)for(;d.length;)this.removeListener(a,d[d.length-1]);return delete this._events[a],this},b.prototype.listeners=function(a){return this._events&&this._events[a]?c(this._events[a])?[this._events[a]]:this._events[a].slice():[]},b.prototype.listenerCount=function(a){if(this._events){if(c(a=this._events[a]))return 1;if(a)return a.length}return 0},b.listenerCount=function(a,b){return a.listenerCount(b)}}],a.c=c,a.p="",a(0);var b,c});