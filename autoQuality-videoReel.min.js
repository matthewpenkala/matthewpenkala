window.addEventListener('load', () => {
  (function waitForDependencies() {
    const requiredGlobals = ['BunnyStreamSessionTracker', 'Plyr'];

    // Check if required globals are available
    if (requiredGlobals.some(name => typeof window[name] === 'undefined')) {
      setTimeout(waitForDependencies, 100);
      return;
    }

    // Check if jQuery is available
    if (typeof jQuery === 'undefined') {
      setTimeout(waitForDependencies, 100);
      return;
    }

    $(document).ready(() => {
      // Give the page some time before running the main logic
      setTimeout(() => {
        
        // Assign an ID on double-click of the settings button
        $('div.plyr__controls .plyr__controls__item > button[data-plyr=settings]').on('dblclick', function() {
          $(this).attr('id', 'resolution-button');
        });

        // Attempt to adjust video quality automatically
        (function autoQuality($qualityTrigger) {
          let attempts = 75;

          const tryAdjustQuality = () => {
            const $settingsMenu = $('div.plyr__controls__item div > div[id^=plyr-settings][id$=quality]');

            if ($qualityTrigger.length && $settingsMenu.length) {
              const $autoBtn = $settingsMenu
                .find('div[role=menu]')
                .first()
                .children('button[data-plyr=quality]:contains("Auto")')
                .first();

              const textMatch = $autoBtn
                .find('span:contains("Auto (")')
                .text()
                .match(/\d+(?=p)/);

              if (textMatch && textMatch.length > 0) {
                const autoQualityVal = parseInt(textMatch[0], 10);
                // If auto quality is less than 720p, switch to 720p
                if (autoQualityVal < 720) {
                  $settingsMenu
                    .find('span:not(.plyr__badge):contains("720")')
                    .parent('button')
                    .prop('checked', true);
                }
              }

              // After the video starts playing, revert to the auto button after 5 seconds
              $('.plyr__video-wrapper > video').on('play', () => {
                setTimeout(() => {
                  $autoBtn.prop('checked', true);
                }, 5000);
              });
            } else if (--attempts > 0) {
              setTimeout(tryAdjustQuality, 250);
            }
          };

          tryAdjustQuality();
        })($('button.plyr__control[data-plyr=settings] > span:contains("Quality")'));

      }, 2000);
    });
  })();
});
